name: Build macOS Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allow manual trigger
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Install Fyne command
      run: |
        go install fyne.io/fyne/v2/cmd/fyne@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: go mod download

    - name: Build macOS executable
      run: |
        MACOSX_DEPLOYMENT_TARGET=15.0 go build -o buchisy-macos ./cmd/buchisy
        chmod +x buchisy-macos

    - name: Create macOS .app bundle
      run: |
        MACOSX_DEPLOYMENT_TARGET=15.0 fyne package -os darwin \
          -name BuchISY \
          -appID com.bergx2.buchisy \
          -src ./cmd/buchisy

        # Copy assets into the app bundle
        mkdir -p BuchISY.app/Contents/Resources
        cp -r assets BuchISY.app/Contents/Resources/

    - name: Create DMG installer (optional)
      run: |
        # Create a temporary directory for DMG contents
        mkdir -p dmg-contents
        cp -r BuchISY.app dmg-contents/

        # Create Applications symlink
        ln -s /Applications dmg-contents/Applications

        # Create DMG
        hdiutil create -volname "BuchISY" \
          -srcfolder dmg-contents \
          -ov -format UDZO \
          BuchISY-macOS.dmg

    - name: Create ZIP archive
      run: |
        zip -r BuchISY-macOS.zip BuchISY.app
        echo "Created BuchISY-macOS.zip"

    - name: Test app bundle exists and show info
      run: |
        if [ -d "BuchISY.app" ]; then
          echo "‚úÖ Build successful!"
          echo "üì¶ App bundle created: BuchISY.app"
          du -sh BuchISY.app
          echo ""
          echo "üì¶ ZIP archive:"
          ls -lh BuchISY-macOS.zip
          echo ""
          if [ -f "BuchISY-macOS.dmg" ]; then
            echo "üì¶ DMG installer:"
            ls -lh BuchISY-macOS.dmg
          fi
        else
          echo "‚ùå Build failed!"
          exit 1
        fi

    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: BuchISY-macOS-${{ github.sha }}
        path: BuchISY-macOS.zip
        retention-days: 30

    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: BuchISY-macOS-DMG-${{ github.sha }}
        path: BuchISY-macOS.dmg
        retention-days: 30

    - name: Create Release (only on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          BuchISY-macOS.zip
          BuchISY-macOS.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}